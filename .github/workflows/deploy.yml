# GitHub Actions Deployment Workflow
# Generated with the help of Claude Sonnet 4.5
# Reviewed by Andrew Kelton


name: Deploy to Digital Ocean

on:
  push:
    branches:
      - staging
      # - main  # Uncomment to deploy from main branch as well

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Deploy to Digital Ocean
      env:
        SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        SERVER_IP: 209.97.158.98
      run: |
        # Setup SSH
        mkdir -p ~/.ssh
        echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H $SERVER_IP >> ~/.ssh/known_hosts
        
        # Deploy to server
        ssh -o StrictHostKeyChecking=no root@$SERVER_IP << 'EOF'
          # Navigate to web root or create a project directory
          cd /var/www/html

          # Fix git ownership issue
          git config --global --add safe.directory /var/www/html
          
          # Check if this is already a git repo
          if [ -d ".git" ]; then
            # Already a repo, just pull latest changes
            git pull origin staging
          else
            # Not a git repo yet - need to initialize
            # Option 1: Clear directory and clone (CAUTION: deletes existing files)
            rm -rf /var/www/html/*
            rm -rf /var/www/html/.*  2>/dev/null || true
            git clone -b staging https://github.com/AdamAddem/Small-Project.git .
            
            # Option 2: Deploy to subdirectory instead (uncomment if you prefer)
            # cd /var/www
            # rm -rf myapp
            # git clone -b staging https://github.com/AdamAddem/Small-Project.git myapp
          fi
          
          # Add any additional deployment commands here
          # For example:
          # npm install
          # composer install
          # systemctl restart nginx
        EOF